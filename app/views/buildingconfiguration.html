<!-- Building error messages -->
<div class="callout callout-danger" ng-if="buildingConfig.buildingSaveError">
  <h4>Building save failed</h4>
  <p>There was a problem while saving the building. Please try again.</p>
</div>

<div class="callout callout-success" ng-if="buildingConfig.buildingSaveSuccess">
  <h4>Building saved successfully</h4>
  <p>The building has been saved successfully.</p>
</div>

<div class="row">
  <div class="col-md-6">
    <!-- Building parameters -->
    <div class="box box-primary">
      <div class="box-header with-border">
        <h3 class="box-title">Parameters</h3>
      </div>
      <form role="form" name="editBuildingForm" novalidate>
          <div class="box-body">
            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.lowVoltageLevel.$dirty && editBuildingForm.lowVoltageLevel.$invalid}">
              <label for="lowVoltageLevel">Critical low voltage level</label>
              <p>This is the voltage considered low. This is used to adjust the battery state of charge and automatically activate the generator. This is typically the LVSD trigger voltage.</p>
              <div class="input-group">
                <input class="form-control" type="number" ng-model="buildingConfig.building.lowVoltageLevel" name="lowVoltageLevel" id="lowVoltageLevel" required>
                <span class="input-group-addon">Volts</span>
              </div>
            </div>

            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.lowVoltageTriggerTime.$dirty && editBuildingForm.lowVoltageTriggerTime.$invalid}">
              <label for="lowVoltageTriggerTime">Low voltage trigger time</label>
              <p>The battery is considered empty once its voltage is at or below the critical low voltage level for this amount of time. Used to adjust the battery state of charge. Typically around half the time until LVSD.</p>
              <div class="input-group">
                <input class="form-control" type="number" ng-model="buildingConfig.building.lowVoltageTriggerTime" name="lowVoltageTriggerTime" id="lowVoltageTriggerTime" required>
                <span class="input-group-addon">seconds</span>
              </div>
            </div>

            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.dailyAgingPercentage.$dirty && editBuildingForm.dailyAgingPercentage.$invalid}">
              <label for="dailyAgingPercentage">Daily Aging Percentage</label>
              <p>The amount the battery level will decrease by each day. This is used to ensure the battery capacity is correct (the battery capacity will be re-calibrated if set too low). The recommended amount is 2% per day.</p>
              <div class="input-group">
                <input class="form-control" type="number" ng-model="buildingConfig.building.dailyAgingPercentage" name="dailyAgingPercentage" id="dailyAgingPercentage" required>
                <span class="input-group-addon">% per day</span>
              </div>
            </div>

            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.tolerancePercentage.$dirty && editBuildingForm.tolerancePercentage.$invalid}">
              <label for="tolerancePercentage">Tolerance Percentage</label>
              <p>The tolerance percentage defines when re-calibration events will occur. The recommended amount is &plusmn;5%. This means the battery capacity will be adjusted upwards once it reaches 105%, and state of charge won't be re-calculated until it reaches -5%.</p>
              <div class="input-group">
                <span class="input-group-addon">&plusmn;</span>
                <input class="form-control" type="number" ng-model="buildingConfig.building.tolerancePercentage" name="tolerancePercentage" id="tolerancePercentage" required>
                <span class="input-group-addon">%</span>
              </div>
            </div>

            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.highPowerThreshold.$dirty && editBuildingForm.highPowerThreshold.$invalid}">
              <label for="highPowerThreshold">High power threshold</label>
              <p>This is the power in watts that is considered high and out of the ordinary. LVSD events caused by high power loads don't represent low battery levels so do not contribute to the state of the system. Can be used for generator automation.</p>
              <div class="input-group">
                <input class="form-control" type="number" ng-model="buildingConfig.building.highPowerThreshold" name="highPowerThreshold" id="highPowerThreshold" required>
                <span class="input-group-addon">Watts</span>
              </div>
            </div>

            <div class="form-group">
              <label for="onlyProcessAfter">Process data after (optional)</label>
              <p>
                Processes data starting at the defined date and time. If not defined, all data up to "Process data until" is processed.
              </p>
              <input type="text" class="form-control"
                datetimepicker
                options="buildingConfig.datePickerOptions"
                placeholder="The start of collection."
                name="onlyProcessAfter"
                date="buildingConfig.onlyProcessAfterObject">
            </div>

            <div class="form-group">
              <label for="onlyProcessUntil">Process data until (optional)</label>
              <p>
                Stops processing data after the defined date and time. If not defined, all data up to the latest reading is processed.
              </p>
              <input type="text" class="form-control"
                datetimepicker
                options="buildingConfig.datePickerOptions"
                placeholder="Forever"
                name="onlyProcessUntil"
                date="buildingConfig.onlyProcessUntilObject">
            </div>

            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.recalculateChargeEfficiencyCapacityMultiplier.$dirty && editBuildingForm.recalculateChargeEfficiencyCapacityMultiplier.$invalid}">
              <label for="recalculateChargeEfficiencyCapacityMultiplier">Re-calculate charge efficiency multiplier</label>
              <p>
                For the charge efficiency to be calculated, their must be sufficient energy in/out since the last time the battery was empty. The level required for this is a multiple of the current battery capacity. The recommended value is 2 x the current battery capacity.
              </p>
              <div class="input-group">
                <input class="form-control" type="number" ng-model="buildingConfig.building.recalculateChargeEfficiencyCapacityMultiplier" name="recalculateChargeEfficiencyCapacityMultiplier" id="recalculateChargeEfficiencyCapacityMultiplier" required>
                <span class="input-group-addon">times the current charge capacity</span>
              </div>
            </div>

            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.minutesBetweenReadingsToIgnore.$dirty && editBuildingForm.minutesBetweenReadingsToIgnore.$invalid}">
              <label for="minutesBetweenReadingsToIgnore">Size of reading gaps to ignore (optional)</label>
              <p>
                When there are large gaps between readings, this can cause incorrect data while processing. This allows the threshold for a reading to be ignored to be defined. This is defined in minutes. If not defined, there is no limit for the size of gaps. The recommended value is 5 minutes.
              </p>
              <div class="input-group" ng-if="buildingConfig.building.minutesBetweenReadingsToIgnore">
                <input class="form-control" type="number" ng-model="buildingConfig.building.minutesBetweenReadingsToIgnore" name="minutesBetweenReadingsToIgnore" id="minutesBetweenReadingsToIgnore">
                <span class="input-group-addon">Minute(s) gap</span>
              </div>
              <div ng-if="!buildingConfig.building.minutesBetweenReadingsToIgnore">
                <input class="form-control" type="number" ng-model="buildingConfig.building.minutesBetweenReadingsToIgnore" name="minutesBetweenReadingsToIgnore" id="minutesBetweenReadingsToIgnore"
                placeholder="Don't ignore gaps">
              </div>
            </div>

            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.otherEnergySourceName.$dirty && editBuildingForm.otherEnergySourceName.$invalid}">
              <label for="otherEnergySourceName">Other energy source name</label>
              <p>This is the name that is given to all sources of energy without individual current sensors. Depending on the system, this may represent all the sources of energy, so "All" may be an appropriate name, or it could represent a single source, for example, "Wind".</p>
              <input class="form-control" ng-model="buildingConfig.building.otherEnergySourceName" name="otherEnergySourceName" id="otherEnergySourceName" required>
            </div>

            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.chargerEnergySourceName.$dirty && editBuildingForm.chargerEnergySourceName.$invalid}">
              <label for="chargerEnergySourceName">Charger energy source name</label>
              <p>This is the name that is given to the charger. The charger is assumed to run through the inverter so is detected when the load current is above zero.</p>
              <input class="form-control" ng-model="buildingConfig.building.chargerEnergySourceName" name="chargerEnergySourceName" id="chargerEnergySourceName" required>
            </div>

            <div class="form-group">
              <label for="batteryCurrentSensor">Battery current sensor</label>
              <p>This is the sensor that is used to measure the battery current used in state of charge calculations. Assumes positive means charging.</p>
              <div sensor-selector building="buildingConfig.building" model="buildingConfig.building.batteryCurrentSensorId"></div>
            </div>

            <div class="form-group">
              <label for="batteryVoltageSensor">Battery voltage sensor</label>
              <p>This is the sensor that is used to measure the battery voltage used in state of charge calculations. This is also used to detect a likey LVSD state with te LVSD voltage.</p>
              <div sensor-selector building="buildingConfig.building" model="buildingConfig.building.batteryVoltageSensorId"></div>
            </div>

            <div class="form-group">
              <label for="buildingPowerSensor">Building power sensor</label>
              <p>This is the sensor for the building's total power usage. This is used with the high power threshold to detect situations where LVSD may occur but not due to low battery level.</p>
              <div sensor-selector building="buildingConfig.building" model="buildingConfig.building.buildingPowerSensorId"></div>
            </div>

            <div class="form-group">
              <label for="loadCurrentSensor">Load current sensor</label>
              <p>This is the sensor that records the current through the inverter/charger. If this is above zero, then the system is being charged by an external source. This allows the incoming charge to be measured.</p>
              <div sensor-selector building="buildingConfig.building" model="buildingConfig.building.loadCurrentSensorId"></div>
            </div>

            <div class="form-group">
              <label for="houseConsumptionColour">House consumption colour</label>
              <p>This is the colour to display house consumption as in graphs.</p>
              <div colour-selector model="buildingConfig.building.houseConsumptionColour"></div>
            </div>

            <div class="form-group">
              <label for="chargerGenerationColour">Charger generation colour</label>
              <p>This is the colour to display charger generation as in graphs.</p>
              <div colour-selector model="buildingConfig.building.chargerGenerationColour"></div>
            </div>

            <div class="form-group">
              <label for="otherGenerationColour">Other source generation colour</label>
              <p>This is the colour to display the 'other' energy source generation as in graphs.</p>
              <div colour-selector model="buildingConfig.building.otherGenerationColour"></div>
            </div>

            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.standardPowerAxis.$dirty && editBuildingForm.standardPowerAxis.$invalid}">
              <label for="standardPowerAxis">Standard axis for power graphs</label>
              <p>This is the power that is used as the Y axis for power graphs, unless a higher value is required.</p>
              <div class="input-group">
                <input class="form-control" type="number" ng-model="buildingConfig.building.standardPowerAxis" name="standardPowerAxis" id="standardPowerAxis" required>
                <span class="input-group-addon">Watts</span>
              </div>
            </div>

            <div class="form-group" ng-class="{ 'has-error' : editBuildingForm.standardDailyEnergyAxis.$dirty && editBuildingForm.standardDailyEnergyAxis.$invalid}">
              <label for="standardDailyEnergyAxis">Standard axis for daily energy graphs</label>
              <p>This is the daily energy in Wh that is used as the Y axis for daily energy graphs, unless a higher value is required.</p>
              <div class="input-group">
                <input class="form-control" type="number" ng-model="buildingConfig.building.standardDailyEnergyAxis" name="standardDailyEnergyAxis" id="standardDailyEnergyAxis" required>
                <span class="input-group-addon">Wh</span>
              </div>
            </div>

          </div>
          <div class="box-footer">
            <button ng-disabled="editBuildingForm.$invalid" type="submit" ng-click="buildingConfig.saveBuilding()" class="btn btn-primary">Save</button>
          </div>
      </form>
    </div>
  </div>
  <div class="col-md-6">
    <!-- State generation status. -->
    <div class="box box-primary">
      <div class="box-header with-border">
        <h3 class="box-title">Data processing</h3>
      </div>
      <div class="box-body">
        <p>
          Re-generate all existing data if a key parameter changes. This will clear all calibration points and states and this process may take several minutes.
        </p>
        <span ng-if="buildingConfig.regenerationStatus === undefined">
          <strong>Loading current state...</strong>
        </span>
        <span ng-if="buildingConfig.regenerationStatus !== undefined && buildingConfig.regenerationStatus.statesAreRegenerating">
          <h4><span class="fa fa-circle-o-notch fa-spin fa-fw"></span> Processing data.</h4>
          The processing status will update automatically.
        </span>
        <span ng-if="buildingConfig.regenerationStatus !== undefined && !buildingConfig.regenerationStatus.statesAreRegenerating">
          <h4><span class="fa fa-check"></span> Processing live data.</h4>
          <button ng-disabled="editBuildingForm.regenerationStatus.statesAreRegenerating" ng-click="buildingConfig.regenerateStates()" class="btn btn-primary"><span class="fa fa-refresh"></span> Re-process data</button>

          <span ng-if="buildingConfig.regenerationStatus.lastRegeneration">
            <h4>Last re-process status</h4>
            <table class="table table-bordered">
              <tbody>
                <tr>
                  <td>Started at</td>
                  <td>{{buildingConfig.regenerationStatus.lastRegeneration.startTime | amFromUnix | amDateFormat:dateTimeFormat}}</td>
                </tr>
                <tr>
                  <td>Finished at</td>
                  <td>{{buildingConfig.regenerationStatus.lastRegeneration.finishTime | amFromUnix | amDateFormat:dateTimeFormat}}</td>
                </tr>
                <tr>
                  <td>Time taken</td>
                  <td>{{buildingConfig.regenerationStatus.lastRegeneration.totalTime | number}} seconds</td>
                </tr>
                <tr>
                  <td>Successful readings</td>
                  <td>{{buildingConfig.regenerationStatus.lastRegeneration.numberOfSuccessfulReadings | number}} readings.</td>
                </tr>
                <tr>
                  <td>Failed readings</td>
                  <td>{{buildingConfig.regenerationStatus.lastRegeneration.numberOfFailedReadings | number}} readings.</td>
                </tr>
              </tbody>
            </table>
          </span>
        </span>
      </div>
    </div>

    <!-- Energy sources -->
    <div class="box box-primary">
      <div class="box-header with-border">
        <h3 class="box-title">Energy Sources</h3>
      </div>
      <div class="box-body">
        <!-- Button to create a new energy source -->
        <p>
          <button ng-click="buildingConfig.newEnergySource()" class="btn btn-primary"><span class="fa fa-plus"></span> New energy source</button>
        </p>
                
        <div class="thumbnail" ng-repeat="energySource in buildingConfig.energySources | orderBy: 'hasBeenSaved'">
          <div class="caption">
            <form role="form" name="energySourceForm" novalidate>
              <div class="callout callout-danger" ng-if="energySource.saveError">
                <h4>Energy source save failed</h4>
                <p>There was a problem while saving the energy source. Please try again.</p>
              </div>

              <div class="callout callout-success" ng-if="energySource.saveSuccess">
                <h4>Energy source saved successfully</h4>
                <p>The energy source has been saved successfully.</p>
              </div>

              <div class="form-group" ng-class="{ 'has-error' : energySourceForm.name.$dirty && energySourceForm.name.$invalid}">
                <label for="name">Name</label>
                <p>The name given to the energy source. Used to identify the source in charts or tables.</p>
                <input class="form-control" ng-model="energySource.data.name" name="name" id="name" required>
              </div>

              <div class="form-group">
                <label for="currentSensor">Source Current Sensor</label>
                <p>This is the current sensor that provides the current for this source. Expects values above zero mean charging, and any value below zero is ignored.</p>
                <div sensor-selector building="buildingConfig.building" model="energySource.data.currentSensorId"></div>

                <br>
                <label for="chartColour">Chart colour</label>
                <p>This is the colour to display the source with in graphs.</p>
                <div colour-selector model="energySource.data.chartColour"></div>
                
                <br>
                <button ng-if="energySource.hasBeenSaved" ng-disabled="energySourceForm.$invalid" type="submit" ng-click="buildingConfig.saveEnergySource(energySource)" class="btn btn-primary">Save</button>

                <button ng-if="!energySource.hasBeenSaved" ng-disabled="energySourceForm.$invalid" type="submit" ng-click="buildingConfig.createEnergySource(energySource)" class="btn btn-primary">Create</button>

                <button ng-click="buildingConfig.deleteEnergySource(energySource)" class="btn btn-danger">Delete</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Bridges -->
    <!-- TODO: Add edit, delete, add functunality. -->
    <div class="box box-primary">
      <div class="box-header with-border">
        <h3 class="box-title">Bridges</h3>
      </div>
      <div class="box-body">
        <div ng-repeat="bridge in buildingConfig.building.bridges">
          <div class="thumbnail">
            <div class="caption">
              <h3>{{bridge.name}}</h3>

              <h4>Sensors:</h4>
              <div class="box-body table-responsive no-padding">
                <table class="table table-hover">
                  <tbody>
                    <tr>
                      <th>Name</th>
                      <th>Power type</th>
                      <th>Reading type</th>
                    </tr>
                    <tr ng-repeat="sensor in bridge.sensors">
                      <td>{{sensor.name}}</td>
                      <td>{{buildingConfig.sensorTypes[sensor.type].electricity}}</td>
                      <td>{{buildingConfig.sensorTypes[sensor.type].type}}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>    
      </div>
    </div>
  </div>
</div>